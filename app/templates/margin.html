<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Margin - LiQ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_home.css') }}">
    <style>
        /* OVERRIDE: main container wat breder en compacter */
        .home-container {
            max-width: 1400px;
            width: 96%;
            margin: 0 auto;
            padding: 1.5rem 1.5rem 2rem;
        }

        .layout-wrapper {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
        }

        /* LINKER DETAIL PANEL – nog breder en prominenter */
        .info-panel {
            flex: 0 0 520px;          /* breder gemaakt */
            max-width: 580px;
            min-height: 420px;
            background: rgba(255,255,255,0.98);
            padding: 1.4rem 1.8rem;
            border-radius: 18px;
            box-shadow: 0 4px 22px rgba(0,0,0,0.16);
            position: sticky;
            top: 90px;
            overflow-y: auto;
        }

        .info-panel h3 {
            margin-top: 0;
            margin-bottom: .35rem;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: left;
        }

        .info-panel .placeholder {
            opacity: 0.7;
            font-style: italic;
            margin-top: .3rem;
            margin-bottom: .8rem;
            text-align: left;
        }

        /* Reusable blokken in de info-panel */
        .block {
            margin-bottom: 1.1rem;
            font-size: 0.94rem;
            line-height: 1.4;
        }

        .block-title {
            font-weight: 700;
            margin-bottom: 0.35rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .block-title span.step {
            font-weight: 900;
            margin-right: 0.3rem;
            opacity: 0.9;
        }

        .card-section {
            background: #f7f8fb;
            border-radius: 12px;
            padding: 0.65rem 0.85rem;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.4rem;
            margin-top: 0.4rem;
            font-size: 0.9rem;
        }

        .summary-item-label {
            font-size: 0.75rem;
            opacity: 0.75;
            text-transform: uppercase;
        }

        .summary-item-value {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .badge-row {
            display: flex;
            justify-content: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.6rem;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.18rem 0.65rem;
            border-radius: 999px;
            font-size: 0.78rem;
            background: #eff1f7;
            border: 1px solid rgba(0,0,0,0.05);
            white-space: nowrap;
        }

        .badge-label {
            opacity: 0.7;
            margin-right: 0.25rem;
        }

        .badge-value {
            font-weight: 600;
        }

        .formula-line {
            font-family: "Courier New", monospace;
            font-size: 0.88rem;
        }

        .formula-box {
            background: #f4f6fa;
            border-radius: 10px;
            padding: 0.6rem 0.9rem;
            border: 1px dashed rgba(0,0,0,0.15);
            margin-top: 0.25rem;
        }

        .formula-caption {
            font-size: 0.78rem;
            opacity: 0.75;
            margin-top: 0.35rem;
        }

        .small-note {
            font-size: 0.8rem;
            opacity: 0.75;
            margin-top: 0.3rem;
        }

        .component-list {
            margin: 0.25rem 0 0.3rem 0;
            padding-left: 1.2rem;
        }

        .component-list li {
            margin-bottom: 0.2rem;
        }

        .highlight-bar {
            margin-top: 0.45rem;
            height: 6px;
            border-radius: 999px;
            overflow: hidden;
            background: #eceff5;
            position: relative;
        }

        .highlight-bar-inner {
            position: absolute;
            inset: 0;
            transform-origin: left center;
        }

        .highlight-result {
            font-family: "Courier New", monospace;
            font-size: 0.95rem;
            margin-top: 0.35rem;
        }

        .highlight-result strong {
            font-size: 1.03rem;
        }

        /* Rechterkant: tabel */
        .margin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        .margin-table th,
        .margin-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: left;
        }

        .margin-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .order-row:hover {
            background-color: #ffe8cc !important;
            cursor: pointer;
        }

        .filter-form {
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            justify-content: center;
        }

        .margin-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .right-panel {
            flex: 1 1 auto;
            min-width: 0;
        }

        .average-banner {
            background: linear-gradient(135deg, #f7f1ff 0%, #eef5ff 100%);
            border: 1px solid rgba(0,0,0,0.06);
            border-radius: 16px;
            padding: 1.2rem 1.6rem;
            margin: 1rem auto 1.3rem;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
        }

        .average-label {
            font-size: 0.95rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: #5b4d83;
            margin-bottom: 0.35rem;
            font-weight: 700;
        }

        .average-metric {
            font-size: 3rem;
            font-weight: 900;
            color: #2f1f55;
            line-height: 1.1;
        }

        .average-context {
            margin-top: 0.25rem;
            font-size: 1rem;
            color: #4f4f4f;
        }
    </style>
</head>
<body>

<div class="home-container">
    <img src="{{ url_for('static', filename='logo.svg') }}" alt="Liq logo" class="logo">

    <h1>
        Margin overview
        {% if selected_year %}
            ({{ selected_year }})
        {% endif %}
    </h1>

    <p class="subtitle">
        The net margin is calculated by subtracting all the costs from the revenue and
        representing it as a percentage of the total price paid for the specific order
        line. An order line is the share of one specific product in an order. Hover over
        the table to see more details.
    </p>

    <!-- FILTERS -->
    <form method="get"
          action="{{ url_for('main.margin_page') }}"
          class="filter-form">

        <!-- Year -->
        <label for="year">Year:</label>
        <select name="year" id="year">
            <option value="">-- Choose a Year --</option>
            {% for y in years %}
                <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>
                    {{ y }}
                </option>
            {% endfor %}
        </select>

        <!-- Country -->
        <label for="country">Country:</label>
        <select name="country" id="country">
            <option value="">All Countries</option>
            {% for country in countries %}
                <option value="{{ country }}" {% if selected_country == country %}selected{% endif %}>
                    {{ country }}
                </option>
            {% endfor %}
        </select>

        <!-- Client (optional) -->
        <label for="client_id">Client:</label>
        <select name="client_id" id="client_id">
            <option value="">-- All clients --</option>
            {% for c in clients %}
                <option value="{{ c.CLIENT_ID }}" {% if selected_client_id == c.CLIENT_ID %}selected{% endif %}>
                    {{ c.Name }}
                </option>
            {% endfor %}
        </select>

        <button type="submit">Show margin</button>
    </form>

    <div class="margin-result">
        {% if avg_margin is not none and selected_year %}
            <div class="average-banner">
                <div class="average-label">Average of all shown margins</div>
                <div class="average-metric">{{ avg_margin }} €</div>
                <div class="average-context">Based on {{ order_count }} orders in the applied filters</div>
                {% if avg_margin_pct is not none %}
                    <div class="average-context">Average margin % of revenue: {{ avg_margin_pct }} %</div>
                {% endif %}
            </div>

            <h2>Net margin summary ({{ selected_year }})</h2>

            <p class="margin-value">
                Average net margin per order: {{ avg_margin }} €
            </p>
            <p class="margin-value">
                Total net margin (all orders): {{ sum_margin }} €
            </p>
            <p class="subtitle">
                Included orders: {{ order_count }}
                {% if selected_client_id %}
                    (selected client only)
                {% elif selected_country %}
                    (all clients in {{ selected_country }})
                {% else %}
                    (all clients in all countries)
                {% endif %}
            </p>

            {% if orders %}
                <div class="layout-wrapper">

                    <!-- LINKER DETAIL PANEL -->
                    <div class="info-panel" id="info-panel">
                        <h3>Calculations of the margin</h3>
                        <p class="placeholder">
                            Hover an order row on the right to see the detailed margin
                            calculation for that specific order.
                        </p>
                    </div>

                    <!-- RECHTER TABEL PANEL -->
                    <div class="right-panel">
                        <h3>Orders in {{ selected_year }}</h3>
                        <table class="margin-table">
                            <thead>
                            <tr>
                                <th>Order nr.</th>
                                <th>Date</th>
                                <th>Revenue (Paid_price)</th>
                                <th>Net margin</th>
                                <th>Margin % of revenue</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for o in orders %}
                                <tr class="order-row"
                                    data-ordernr="{{ o.order_nr }}"
                                    data-date="{{ o.order_date }}"
                                    data-revenue="{{ o.revenue }}"
                                    data-margin="{{ o.order_margin }}"
                                    data-marginpct="{{ o.margin_pct }}"
                                    data-prod="{{ o.prod_sum }}"
                                    data-inbound="{{ o.inbound_sum }}"
                                    data-storage="{{ o.storage_sum }}"
                                    data-outbound="{{ o.outbound_sum }}"
                                    data-license="{{ o.license_amount }}"
                                    data-opc="{{ o.orders_per_client }}"
                                    data-qty="{{ o.total_quantity|default(0) }}">
                                    <td>{{ o.order_nr }}</td>
                                    <td>{{ o.order_date }}</td>
                                    <td>{{ o.revenue }} €</td>
                                    <td>{{ o.order_margin }} €</td>
                                    <td>
                                        {% if o.margin_pct is not none %}
                                            {{ o.margin_pct }} %
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>
            {% else %}
                <p class="subtitle">
                    There are no orders for this selection in {{ selected_year }}.
                </p>
            {% endif %}

        {% else %}
            <p class="subtitle">
                First select a year (and optionally a country and/or client) and then click
                <strong>"Show margin"</strong> to view the results.
            </p>
        {% endif %}
    </div>

    <a href="{{ url_for('main.home_page') }}"><button>Back</button></a>
</div>

<script>
    const panel = document.getElementById("info-panel");
    const rows = document.querySelectorAll(".order-row");

    function euro(v) {
        return Number(v).toFixed(2) + " €";
    }

    rows.forEach(row => {
        row.addEventListener("mouseenter", () => {
            const revenue   = Number(row.dataset.revenue || 0);
            const margin    = Number(row.dataset.margin || 0);
            const prod      = Number(row.dataset.prod || 0);
            const inbound   = Number(row.dataset.inbound || 0);
            const storage   = Number(row.dataset.storage || 0);
            const outbound  = Number(row.dataset.outbound || 0);  // allocated outbound for this order
            const licence   = Number(row.dataset.license || 0);
            const opc       = Number(row.dataset.opc || 0);       // orders per client in year
            const qty       = Number(row.dataset.qty || 0);       // total quantity in order
            const marginPct = row.dataset.marginpct || "-";

            const licencePct = revenue ? (licence / revenue * 100) : 0;

            // Gemiddelde kosten per product (over alle units in de order, nog NIET vermenigvuldigd met aantal)
            let inboundPerProduct = "-";
            let storagePerProduct = "-";
            let outboundPerProduct = "-";
            if (qty > 0) {
                inboundPerProduct  = euro(inbound / qty);
                storagePerProduct  = euro(storage / qty);
                outboundPerProduct = euro(outbound / qty);
            }

            panel.innerHTML = `
                <h3>Calculations of the margin</h3>

                <!-- 0. Context badges -->
                <div class="badge-row">
                    <div class="badge">
                        <span class="badge-label">Order</span>
                        <span class="badge-value">${row.dataset.ordernr}</span>
                    </div>
                    <div class="badge">
                        <span class="badge-label">Date</span>
                        <span class="badge-value">${row.dataset.date}</span>
                    </div>
                    <div class="badge">
                        <span class="badge-label">Units</span>
                        <span class="badge-value">${qty || "-"}</span>
                    </div>
                </div>

                <!-- 1. VARIABLES -->
                <div class="block">
                    <div class="block-title"><span class="step">1.</span>Variables</div>
                    <div class="card-section">
                        <ul class="component-list">
                            <li>
                                <strong>Inbound transport cost per product:</strong>
                                ${inboundPerProduct}
                            </li>
                            <li>
                                <strong>Storage cost per product:</strong>
                                ${storagePerProduct}
                            </li>
                            <li>
                                <strong>Outbound transport cost per product:</strong>
                                ${outboundPerProduct}
                            </li>
                            <li>
                                <strong>License fee percentage:</strong>
                                ${revenue ? licencePct.toFixed(2) + " %" : "-"}
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- 2. FORMULE -->
                <div class="block">
                    <div class="block-title"><span class="step">2.</span>How the margin is calculated</div>
                    <div class="card-section formula-box">
                        <div class="formula-line">
                            Net margin = Paid price − Production costs − Inbound transport − Storage
                        </div>
                        <div class="formula-line">
                            &nbsp;&nbsp;&nbsp;&nbsp;− Client outbound share − Licence fee (percentage of Paid price)
                        </div>
                    </div>
                    <div class="card-section formula-box" style="margin-top:0.35rem;">
                        <div class="formula-line">For this order:</div>
                        <div class="formula-line">
                            {{"${"}}euro(revenue){{"}"}} − {{"${"}}euro(prod){{"}"}} − {{"${"}}euro(inbound){{"}"}} − {{"${"}}euro(storage){{"}"}}
                        </div>
                        <div class="formula-line">
                            − {{"${"}}euro(outbound){{"}"}} − {{"${"}}euro(licence){{"}"}} = <strong>{{"${"}}euro(margin){{"}"}}</strong>
                            ${marginPct !== "-" ? ` (${marginPct} % of Paid price)` : ""}                        </div>
                    </div>
                </div>


            `;
        });
    });
</script>

</body>
</html>
